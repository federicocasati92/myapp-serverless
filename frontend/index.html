<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Click Counter with Cognito</title>
  <link rel="icon" href="data:;base64,iVBORw0KGgo=" />
</head>
<body>
  <h1>Click Counter</h1>

  <!-- Buttons -->
  <button id="loginBtn">Login with Cognito</button>
  <button id="logoutBtn" style="display: none;">Logout</button>
  <button id="btnCount" disabled>Click total</button>

  <p>Total clicks: <span id="count">0</span></p>

  <script>
    // === Cognito and API Gateway configuration ===
    const REGION = 'us-east-1';
    const CLIENT_ID = '7kob7less0v0j8qi36jnhd9o6g';
    const userPoolDomain = 'us-east-1crtzroy18.auth.us-east-1.amazoncognito.com';
    const redirectUri = 'https://dtn4bsrr7bbyf.cloudfront.net/index.html';
    const API_URL = 'https://7ua2wf7t5b.execute-api.us-east-1.amazonaws.com/prod/click';

    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const btnCount = document.getElementById("btnCount");
    const countDisplay = document.getElementById("count");

    // === Construct login and logout URLs ===
    const loginUrl = `https://${userPoolDomain}/login?response_type=token&client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(redirectUri)}`;
    const logoutUrl = `https://${userPoolDomain}/logout?client_id=${CLIENT_ID}&logout_uri=${encodeURIComponent(redirectUri)}`;

    // === Login handling ===
    loginBtn.addEventListener("click", () => {
      window.location.href = loginUrl;
    });

    // === Logout handling ===
    logoutBtn.addEventListener("click", () => {
      sessionStorage.removeItem("id_token");
      window.location.href = logoutUrl;
    });

    // === Extract token from URL if present ===
    function extractTokenFromUrl() {
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      const token = params.get("id_token");
      if (token) {
        sessionStorage.setItem("id_token", token);
        // Remove fragment from URL for cleanup
        window.history.replaceState(null, null, window.location.pathname);
      }
      return token;
    }

    // === Retrieve token from URL or sessionStorage ===
    let token = extractTokenFromUrl() || sessionStorage.getItem("id_token");

    if (token) {
      btnCount.disabled = false;
      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline";

      btnCount.addEventListener("click", () => {
        fetch(API_URL, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        })
        .then(res => {
          if (!res.ok) throw new Error("API Error: " + res.status);
          return res.json();
        })
        .then(data => {
          countDisplay.textContent = data.count ?? 'N/A';
        })
        .catch(err => {
          countDisplay.textContent = "Error: " + err.message;
        });
      });
    } else {
      loginBtn.style.display = "inline";
      logoutBtn.style.display = "none";
      btnCount.disabled = true;
    }
  </script>
</body>
</html>
